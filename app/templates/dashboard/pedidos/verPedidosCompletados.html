<title>Pedidos registrados</title>

{% extends "dashboard/basemenu.html" %}

{% block title %}Pedidos Registrados{% endblock %}



{% block sidebar %}{% endblock %}



{% block content %} 
<link rel="stylesheet" href="{{ url_for('static', filename='assets/css/verPedidos1.css')}}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

    <main class=" px-md-4">
      <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <ul class=" nav nav-tabs">
          <a class="h4 nav-link "style="color: black;" href="{{url_for('verRegistrosPedidos')}}">Pedidos en curso</a>
       
          <a class=" h4 nav-link active" href="{{url_for('verRegistrosPedidosCompletados')}}"> Completados</a>
        
      </ul>  
        <button type="button" href="#" class="btn btn-light">Exportar PDF</button>
  </div>

<div class="filtros-container">     
  
  <div></div>
<div class="filtro-fecha" style="justify-content: right;">
    <label for="orden-fecha">Ordenar por fecha:</label>
    <select id="orden-fecha" class="filtro-select">
        <option value="reciente">Más Reciente</option>
        <option value="antiguo">Más Antiguo</option>
    </select>
</div>
</div> 
  <div id="pedidos-container">

    {% for d in dataPedidos4 %}
    <div class="pedido-item"data-fecha="{{ d.fecha_pedido }}"style="
      
        border-left: 5px solid #75dd71;
      
    ">
  
        <div class="pedido-info">
          <div><strong>Cliente:</strong> {{ d.nombre_cliente }} {{ d.apellido_cliente }}  
          <div class="text-muted" style="font-size: 12px;"><strong>Fecha del trabajo:</strong> {{d.fecha_inicio_trabajo}} - {{d.fecha_fin_trabajo}}</div>
          <div><strong>Estado de pedido:</strong> {{ d.estado_pedido }}</div>
  
            <div class="extra-info">
                          <strong>Técnico encargado:</strong> {{ d.nombre_tecnico }} {{ d.apellido_tecnico }}</div>
                          <div><strong></strong>   
                <strong>Fecha:</strong> {{ d.fecha_pedido }}</div>
                
            </di>
        </div>
    
  
        <div class="botones">
          
          <button class="btn btn-sm"  id="btn-edit{{d.cedula}}" data-bs-toggle="modal" data-bs-target="#modalCompletado{{d.cedula}}
          ">Ver detalles</button>
          <button class="eliminar btn  btn-sm" id="btn-eliminar{{d.codigo_pedido}}" data-bs-toggle="modal" data-bs-target="#modaleliminar{{d.codigo_pedido}}" >Eliminar</button>
          
        </div>
   
</div>

    </div>
  {% endfor %}



              <!-- modal -->

              {% for d in dataPedidos2 %}
  
              <div class="modal fade" id="modal{{d.cedula}}" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h1 class="modal-title fs-5" id="exampleModalLabel">{{d.nombre}} {{d.apellido}}</h1>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form action="/editPedido/{{d.cedula}}" method="post">
  
                           
                          <label for="cliente" class="form-label mt-1">Cliente</label>
                          <select name="cliente" id="cliente" class="form-control" required>
                              <option value="{{d.cedula_cliente}}" selected="selected">{{d.nombre_cliente}} {{d.apellido_cliente}}</option>
                              {% for c in dataClientes %}
                                <option value="{{ c.cedula}}">{{c.nombre}} {{c.apellido}}</option> 
                                {% endfor %} 
                          </select>                          
                            <label>Código de pedido</label>
                            <input type="text" class="codigo_pedido form-control" name="codigo_pedido" value="{{d.codigo_pedido}}" readonly>
                            <label for="tecnico" class="form-label mt-1">Técnico asigando</label>
                              <select name="tecnico" class="form-control" required>
                                <option value="{{d.cedula_tecnico}}" selected="selected">{{d.nombre_tecnico}} {{d.apellido_tecnico}}</option>
                                {% for c in dataTecnicos %}
                                <option value="{{ c.cedula}}">{{c.nombre}} {{c.apellido}}</option>
                                {% endfor %}
                              </select>
                              <label>Fecha</label>
                              <input type="text" class="form-control mb-3 fecha_pedido" id="fecha_pedido"name="fecha_pedido" value="{{d.fecha_pedido}}">
                            <label class="text-muted">Registrado por empleado {{d.cedula_empleado_registra}} {{d.nombre_empleado}} {{d.apellido_empleado}}</label>
                     
                    </div>
                    <div class="modal-footer">
                      <button type="submit" class="btn btn-primary">Guardar cambios</button>
                    </div>
                        </form>
                      </div>
                    </div>
                  </div>
  
                
                      </div>
                    </div>
                  </div>

                              <!-- modal editar y ver detalles pedidos en proceso-->

              
                          <div class="modal fade" id="modalProceso{{d.cedula}}" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                            <div class="modal-dialog">
                              <div class="modal-content">
                                <div class="modal-header">
                                  <h1 class="modal-title fs-5" id="exampleModalLabel">Detalles del pedido</h1>
                                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <form action="/editPedidoProceso/{{d.cedula}}" method="post">
              
                                      
                                      <label for="cliente" class="form-label mt-1">Cliente: {{d.nombre_cliente}} {{d.apellido_cliente}}</label>
                                                            
                                       <div> <label>Código de pedido</label></div>
                                        <input type="text" class="codigo_pedido form-control" name="codigo_pedido" value="{{d.codigo_pedido}}" readonly>
                                        <label for="tecnico" class="form-label mt-1">Técnico asigando</label>
                                          <select name="tecnico" class="form-control" required>
                                            <option value="{{d.cedula_tecnico}}" selected="selected">{{d.nombre_tecnico}} {{d.apellido_tecnico}}</option>
                                            {% for c in dataTecnicos %}
                                            <option value="{{ c.cedula}}">{{c.nombre}} {{c.apellido}}</option>
                                            {% endfor %}
                                          </select>
                                          <label>Fecha del pedido</label>
                                          <input readonly type="text" class="form-control mb-3" name="fecha_pedido" value="{{d.fecha_pedido}}">

                                        <label for="servicio" class="form-label mt-1">Servicio</label>
                                        <select name="servicio" class="form-control" id="servicio" required>
                                          <option value="{{d.codigo_servicio}}" selected="selected">{{d.tipo}} - {{d.servicio_descripcion}}</option>
                                          {% for c in dataServicios %}
                                          <option value="{{ c.codigo_servicio}}">{{c.tipo}} - {{c.descripcion}}</option>
                                          {% endfor %}
                                        </select>
                                        <label for="fecha_inicio_trabajo" >Fecha de inicio del trabajo</label>
                                        <input class="form-control" value="{{d.fecha_inicio_trabajo}}" required type="text" id="fecha_inicio_trabajo" name="fecha_inicio_trabajo" class="fecha_inicio_trabajo" required>
                                                    <label class="text-muted">Registrado por empleado {{d.cedula_empleado_registra}} {{d.nombre_empleado}} {{d.apellido_empleado}}</label>

                                  
                                </div>
                                <div class="modal-footer">
                                  <button type="submit" class="btn btn-primary">Guardar cambios</button>
                                </div>
                                    </form>
                                  </div>
                                </div>
                              </div>
              
                            
                                  </div>
                                </div>
                              </div>

                              <!-- modal editar y ver detalles pedidos pendientes de pago-->

              
                          <div class="modal fade" id="modalPendiente{{d.cedula}}" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                            <div class="modal-dialog">
                              <div class="modal-content">
                                <div class="modal-header">
                                  <h1 class="modal-title fs-5" id="exampleModalLabel">Detalles del pedido</h1>
                                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <form action="/editPedidoPendiente/{{d.cedula}}" method="post">
              
                                      
                                      <label for="cliente" class="form-label mt-1">Cliente: {{d.nombre_cliente}} {{d.apellido_cliente}}</label>
                                                            
                                       <div> <label>Código de pedido</label></div>
                                        <input type="text" class="codigo_pedido form-control" name="codigo_pedido" value="{{d.codigo_pedido}}" readonly>
                                        <label for="tecnico" class="form-label mt-1">Técnico asigando</label>
                                          <select name="tecnico" class="form-control" required>
                                            <option value="{{d.cedula_tecnico}}" selected="selected">{{d.nombre_tecnico}} {{d.apellido_tecnico}}</option>
                                            {% for c in dataTecnicos %}
                                            <option value="{{ c.cedula}}">{{c.nombre}} {{c.apellido}}</option>
                                            {% endfor %}
                                          </select>
                                          <label>Fecha del pedido</label>
                                          <input readonly type="text" class="form-control mb-3" name="fecha_pedido" value="{{d.fecha_pedido}}">

                                        <label for="servicio" class="form-label mt-1">Servicio</label>
                                        <select name="servicio" class="form-control" id="servicio" required>
                                          <option value="{{d.codigo_servicio}}" selected="selected">{{d.tipo}} - {{d.servicio_descripcion}}</option>
                                          {% for c in dataServicios %}
                                          <option value="{{ c.codigo_servicio}}">{{c.tipo}} - {{c.descripcion}}</option>
                                          {% endfor %}
                                        </select>
                                        <label for="fecha_inicio_trabajo" >Fecha de inicio del trabajo</label>
                                        <input class="form-control" value="{{d.fecha_inicio_trabajo}}" required type="text" id="fecha_inicio_trabajo" name="fecha_inicio_trabajo" class="fecha_inicio_trabajo" required>
                                        <label for="fecha_fin_trabajo" >Fecha de finalización del trabajo</label>
                                        <input value="{{d.fecha_fin_trabajo}}" class="form-control  "required type="text" id="fecha_fin_trabajo" name="fecha_fin_trabajo" class="fecha_fin_trabajo" >
                                        
                                        <label for="total a pagar">Total a pagar</label>
                                        <input value="{{d.total_a_pagar}}" class="form-control" type="number" id="total_a_pagar" name="total_a_pagar" class="total_a_pagar" >
                                      <label class="text-muted">Registrado por empleado {{d.cedula_empleado_registra}} {{d.nombre_empleado}} {{d.apellido_empleado}}</label>

                                </div>
                                <div class="modal-footer">
                                  <button type="submit" class="btn btn-primary">Guardar cambios</button>
                                </div>
                                    </form>
                                  </div>
                                </div>
                              </div>
              
                            
                                  </div>
                                </div>
                              </div>

                  <!-- modal para borrar-->

                  <div class="modal fade" id="modaleliminar{{d.codigo_pedido}}" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h1 class="modal-title fs-5" id="exampleModalLabel">{{d.nombre}} {{d.apellido}}</h1>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                          <p>¿Está seguro de que desea eliminar este registro?</p>
                          <div class="modal-footer">
                            <a href="{{url_for('deletePedido', codigo_pedido=d.codigo_pedido)}}" class="btn btn-danger btn-sm">Eliminar</a>
                            <button type="button" data-bs-dismiss="modal" class="btn btn-sm" id="cancelarEliminar">Cancelar</button>
                        </div>
                        </div>
                      </div>
                    </div>
                  </div> 
        

                  
                  
              {% endfor %}
  
  
  
  
                </div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"> </script>
<!-- Flatpickr JS -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>

<script>
  flatpickr("#fecha_pedido", {
      dateFormat: "Y-m-d",  // Formato: Año-Mes-Día
      enableTime: false,     // Deshabilitar hora (solo fecha)
      locale: "es"           // Español
  });
</script>
<script>
  flatpickr("#fecha_inicio_trabajo", {
      dateFormat: "Y-m-d",  // Formato: Año-Mes-Día
      enableTime: false,     // Deshabilitar hora (solo fecha)
      locale: "es"           // Español
  });
</script>

<script>
  flatpickr("#fecha_fin_trabajo", {
      dateFormat: "Y-m-d",  // Formato: Año-Mes-Día
      enableTime: false,     // Deshabilitar hora (solo fecha)
      locale: "es"           // Español
  });
  flatpickr("#fecha_pago", {
      dateFormat: "Y-m-d",  // Formato: Año-Mes-Día
      enableTime: false,     // Deshabilitar hora (solo fecha)
      locale: "es"           // Español
  });
  document.addEventListener('DOMContentLoaded', () => {
  const elementosFechaPago = document.querySelectorAll('.fecha_pago2'); // Seleccionar por clase

  elementosFechaPago.forEach(elemento => {
    flatpickr(elemento, {
      dateFormat: "Y-m-d",
      enableTime: false,
      locale: "es"
    });
  });
});


// Inicialización de checkboxes y campos dependientes
document.querySelectorAll(".modal").forEach(modal => {  // Iterar sobre *cada* modal
            modal.addEventListener('shown.bs.modal', () => { // Escuchar el evento 'shown.bs.modal'
                const codigo_pedido = modal.id.replace(/[^0-9]/g, ''); // Extraer el código del pedido del ID del modal
                const checkbox = modal.querySelector(`#cancelado${codigo_pedido}`);
                const detallesPago = modal.querySelector(`#detallesPago${codigo_pedido}`);
                const tipoMoneda = modal.querySelector(`#tipo_moneda${codigo_pedido}`);
                const metodoPago = modal.querySelector(`#metodo_pago${codigo_pedido}`);
                const metodoPagoContainer = modal.querySelector(`#metodoPagoContainer${codigo_pedido}`);
                const referenciaContainer = modal.querySelector(`#referenciaContainer${codigo_pedido}`);
                

                if (!checkbox || !detallesPago || !tipoMoneda || !metodoPago || !metodoPagoContainer || !referenciaContainer) {
                    console.warn(`Algunos elementos del modal ${codigo_pedido} no se encontraron.`);
                    return;
                }

                function actualizarCampos() {
                    detallesPago.style.display = checkbox.checked ? "block" : "none";
                    if (!checkbox.checked) {
                        metodoPagoContainer.style.display = "none";
                        referenciaContainer.style.display = "none";
                    }
                }

                function actualizarMetodosPago() {
                    metodoPago.innerHTML = "";
                    metodoPagoContainer.style.display = "block";
                    if (tipoMoneda.value === "bolivares") {
                        metodoPago.innerHTML = `<option value="efectivo">Efectivo</option><option value="pago_movil">Pago Móvil</option>`;
                    } else {
                        metodoPago.innerHTML = `<option value="efectivo">Efectivo</option><option value="transferencia">Transferencia</option>`;
                    }
                }

                function actualizarReferencia() {
                    referenciaContainer.style.display = (metodoPago.value === "pago_movil" || metodoPago.value === "transferencia") ? "block" : "none";
                }

                checkbox.addEventListener("change", actualizarCampos);
                tipoMoneda.addEventListener("change", actualizarMetodosPago);
                metodoPago.addEventListener("change", actualizarReferencia);

                actualizarCampos();
                actualizarMetodosPago();
                actualizarReferencia();

                
            });
        });

        function filtrarPedidos(filtro) {
    let pedidos = document.querySelectorAll('.pedido-item');

    pedidos.forEach(pedido => {
        if (filtro === 'todos') {
            pedido.style.display = 'flex';
        } else if (pedido.classList.contains(filtro)) {
            pedido.style.display = 'flex';
        } else {
            pedido.style.display = 'none';
        }
    });
        };
document.getElementById("orden-fecha").addEventListener("change", function() {
    let orden = this.value;
    let contenedor = document.getElementById("pedidos-container");
    let pedidos = Array.from(contenedor.getElementsByClassName("pedido-item"));

    pedidos.sort((a, b) => {
        let fechaA = new Date(a.getAttribute("data-fecha"));
        let fechaB = new Date(b.getAttribute("data-fecha"));

        return orden === "reciente" ? fechaB - fechaA : fechaA - fechaB;
    });

    pedidos.forEach(pedido => contenedor.appendChild(pedido));
});
</script>


{% endblock %}
