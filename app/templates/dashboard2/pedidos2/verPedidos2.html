<title>Pedidos registrados</title>

{% extends "dashboard2/basemenu2.html" %}

{% block title %}Pedidos Registrados{% endblock %}



{% block sidebar %}{% endblock %}



{% block content %} 
<link rel="stylesheet" href="{{ url_for('static', filename='assets/css/verPedidos1.css')}}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="{{ url_for('static', filename='assets/js/verpedidos.js')}}"></script>

    <main class=" px-md-4">
      <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <ul class=" nav nav-tabs">
          <a class="h4 nav-link active" style="color: black">Pedidos en curso</a>
       
          <a class="  nav-link " style="color: rgb(66, 64, 64);"href="{{url_for('verRegistrosPedidosCompletados')}}"> Completados</a>
        
      </ul>  
     <div class="d-flex align-items-center mb-3 gap-2">

      <div class="position-relative" style="width: 250px;">
        <input type="text" id="buscarPedido" class="form-control" style="border-radius: 25px; padding-right: 40px;" placeholder="Buscar pedidos...">
        <i class="bx bx-search-alt-2" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: gray; font-size: 20px;"></i>
      </div>
      <a type="button" id="btn-exportar-pdf"  href="{{url_for('generar_reporte_completo_pedidos')}}" class="btn btn-light">Exportar PDF</a>
     </div>
    </div>

<div class="filtros-container">     
  
  <div class="filtro-botones">
    <button onclick="actualizarFiltroEstado('todos')" class="btn filtro-btn" style="border-radius: 25px;">Todos</button>
    <button onclick="actualizarFiltroEstado('por-atender')" class="btn filtro-btn btn-1">Por Atender</button>
    <button onclick="actualizarFiltroEstado('en-proceso')" class="btn filtro-btn btn-2">En Proceso</button>
    <button onclick="actualizarFiltroEstado('pendiente-de-pago')" class="btn filtro-btn btn-3">Pendiente de Pago</button>
</div>
<div class="filtro-fecha">
    <label for="orden-fecha">Ordenar por:</label>
    <select id="orden-fecha" class="filtro-select">
      <option value="">-</option>
        <option value="hoy">Hoy</option>
        <option value="semana">Última semana</option>
        <option value="mes">Último mes</option>
        <option value="reciente">Más reciente</option>
        <option value="antiguo">Más antiguo</option>
    </select>
</div>
</div> 
  <div id="pedidos-container">

  {% for d in dataPedidos2 %}
  <div class="pedido-item {% if d.codigo_estadoDeProceso == 1 %} por-atender 
  {% elif d.codigo_estadoDeProceso == 2 %} en-proceso 
  {% elif d.codigo_estadoDeProceso == 3 %} pendiente-de-pago 
  {% endif %}"data-fecha="{{ d.fecha_pedido }}"style="
    {% if d.codigo_estadoDeProceso == 2 %}
      border-left: 5px solid #87CEEB;
    {% elif d.codigo_estadoDeProceso == 3 %}
      border-left: 5px solid #ff7300;
    {% else %}
      border-left: 5px solid #FFD700;
    {% endif %}
  ">

      <div class="pedido-info">
        <div><strong>Cliente:</strong> {{ d.nombre_cliente }} {{ d.apellido_cliente }}  
        <div class="text-muted" style="font-size: 12px;"><strong>Dirección:</strong> Calle {{ d.calle }}, Sector {{ d.sector }}, casa n° {{ d.numero_casa }}, {{ d.ciudad }}, {{ d.estado }}</div>
        <div><strong>Estado de pedido:</strong> {{ d.estado_pedido }}</div>

          <div class="extra-info">
                        <strong>Teléfono del cliente:</strong> {{ d.prefijo_telefonico }}{{ d.numero }}</div>
<div><strong>Técnico asignado:</strong> {{ d.nombres_tecnicos}} 
              <strong>Fecha:</strong> {{ d.fecha_pedido }}</div>
              
          </di>
      </div>
  

      <div class="botones">
        
        <button class="btn btn-sm"  id="btn-edit{{d.codigo_pedido}}" data-bs-toggle="modal" data-bs-target="{% if d.codigo_estadoDeProceso == 3 %}#modalPendiente{{d.codigo_pedido}}
        {% elif d.codigo_estadoDeProceso == 2 %}#modalProceso{{d.codigo_pedido}}
        {% else %}#modal{{d.codigo_pedido}}{% endif %}">Ver detalles</button>
        <div class="boton-con-icono"><button class="boton toggle" data-bs-toggle="modal" 
          data-bs-target="{% if d.codigo_estadoDeProceso == 3 %}#modalActualizarPendiente{{d.codigo_pedido}}
          {% elif d.codigo_estadoDeProceso == 2 %}#modalActualizarEnProceso{{d.codigo_pedido}}
          {% elif d.codigo_estadoDeProceso == 1 %}#modalDefault{{d.codigo_pedido}}{% endif %}"></button><i class='bx bx-right-arrow-alt'></i></div>
      </div>
 
</div>

    </div>
  {% endfor %}



              <!-- modal editar y ver detalles pedidos por atender -->

              {% for d in dataPedidos2 %}
  
              <div class="modal fade" id="modal{{d.codigo_pedido}}" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h3 class="modal-title fs-5" id="exampleModalLabel">Detalles del pedido</h3>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form action="/editPedido/{{d.codigo_pedido}}" method="post">
  
                           
                          <label for="cliente" class="form-label mt-1">Cliente</label>
                          <select name="cliente" id="cliente" class="form-control" required>
                              <option value="{{d.cedula_cliente}}" selected="selected">{{d.nombre_cliente}} {{d.apellido_cliente}}</option>
                              {% for c in dataClientes %}
                                <option value="{{ c.cedula}}">{{c.nombre}} {{c.apellido}}</option> 
                                {% endfor %} 
                          </select>                          
                            <label>Código de pedido</label>
                            <input type="text" class="codigo_pedido form-control" name="codigo_pedido" value="{{d.codigo_pedido}}" readonly>
                             
                            <div class="row">
                              <div class="col">
                                <div><label for="tecnicos">Técnicos asignados</label></div>
                                  <div >
                                      <select class="tecnicos-select form-control" name="tecnicoSeleccionado[]" multiple >
                                          {% for c in dataTecnicos %}
                                              <option  value="{{ c.cedula }}" 
                                                  {% if d.cedulas_tecnicos and c.cedula|string in d.cedulas_tecnicos.split(',') %} selected {% endif %}>
                                                  {{ c.nombre }} {{ c.apellido }}
                                              </option>
                                          {% endfor %}
                                      </select>
                                  </div>
                              </div>
                          </div>
                          
                          
                          
                             <div> <label>Fecha</label></div>
                              <input type="text" class="form-control mb-3 fecha_pedido" id="fecha_pedido"name="fecha_pedido" value="{{d.fecha_pedido}}">
                            <label class="text-muted">Registrado por empleado {{d.cedula_empleado_registra}} {{d.nombre_empleado}} {{d.apellido_empleado}}</label>
                     
                    </div>
                    <div class="modal-footer">
                    </div>
                        </form>
                      </div>
                    </div>
                  </div>
  
                
                      </div>
                    </div>
                  </div>

                              <!-- modal editar y ver detalles pedidos en proceso-->

              
                          <div class="modal fade" id="modalProceso{{d.codigo_pedido}}" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                            <div class="modal-dialog">
                              <div class="modal-content">
                                <div class="modal-header">
                                  <h3 class="modal-title fs-5" id="exampleModalLabel">Detalles del pedido</h3>
                                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <form action="/editPedidoProceso/{{d.codigo_pedido}}" method="post">
              
                                      
                                      <label for="cliente" class="form-label mt-1">Cliente: {{d.nombre_cliente}} {{d.apellido_cliente}}</label>
                                                            
                                       <div> <label>Código de pedido</label></div>
                                        <input type="text" class="codigo_pedido form-control" name="codigo_pedido" value="{{d.codigo_pedido}}" readonly>
                                        <div>
                                          <div><label for="tecnicos">Técnicos asignados</label></div>
                                          <div>
                                              <select class="tecnicos-select form-control col-md-4" name="tecnicoSeleccionado[]" multiple>
                                                  {% for c in dataTecnicos %}
                                                      <option value="{{ c.cedula }}" 
                                                          {% if d.cedulas_tecnicos and c.cedula|string in d.cedulas_tecnicos.split(',') %} selected {% endif %}>
                                                          {{ c.nombre }} {{ c.apellido }}
                                                      </option>
                                                  {% endfor %}
                                              </select>
                                          </div>
                                      </div>
                                      
                                      
                                      
                                          <label>Fecha del pedido</label>
                                          <input readonly type="text" class="form-control mb-3"  name="fecha_pedido" value="{{d.fecha_pedido}}">

                                          <label for="servicio" class="form-label mt-1">Servicios prestados:</label>

                                                <div>
                                                    <!-- 🔹 Correctivos -->
                                                    <div class="servicios-container">
                                                        <label for="servicios_correctivo">Correctivos</label>
                                                        <div><select class="servicios-select servicios-correctivo form-control" name="serviciosSeleccionados[]" multiple>
                                                            {% for s in dataServiciosCorrectivos %}
                                                                <option value="{{ s.codigo_servicio }}"
                                                                    {% if d.codigos_servicios_correctivos and s.codigo_servicio|string in d.codigos_servicios_correctivos.split(',') %} 
                                                                        selected 
                                                                    {% endif %}>
                                                                    {{ s.descripcion }}
                                                                </option>
                                                            {% endfor %}
                                                        </select></div>
                                                    </div>

                                                    <!-- 🔹 Preventivos -->
                                                    <div class="servicios-container">
                                                        <label for="servicios_preventivo">Preventivos</label>
                                                        <div><select class="servicios-select servicios-preventivo form-control" name="serviciosSeleccionados[]" multiple>
                                                            {% for s in dataServiciosPreventivos %}
                                                                <option value="{{ s.codigo_servicio }}"
                                                                    {% if d.codigos_servicios_preventivos and s.codigo_servicio|string in d.codigos_servicios_preventivos.split(',') %} 
                                                                        selected 
                                                                    {% endif %}>
                                                                    {{ s.descripcion }}
                                                                </option>
                                                            {% endfor %}
                                                        </select></div>
                                                    </div>
                                                </div>

                                                                                                                              
                                           
                                        
                                        <label for="fecha_inicio_trabajo" >Fecha de inicio del trabajo</label>
                                        <input class="form-control fecha_inicio_trabajo" value="{{d.fecha_inicio_trabajo}}" required type="text" id="fecha_inicio_trabajo" name="fecha_inicio_trabajo" class="fecha_inicio_trabajo" required>
                                                    <label class="text-muted">Registrado por empleado {{d.cedula_empleado_registra}} {{d.nombre_empleado}} {{d.apellido_empleado}}</label>

                                  
                                </div>
                                <div class="modal-footer">
                                </div>
                                    </form>
                                  </div>
                                </div>
                              </div>
              
                            
                                  </div>
                                </div>
                              </div>

                              <!-- modal editar y ver detalles pedidos pendientes de pago-->

              
                          <div class="modal fade" id="modalPendiente{{d.codigo_pedido}}" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                            <div class="modal-dialog">
                              <div class="modal-content">
                                <div class="modal-header">
                                  <h3 class="modal-title fs-5" id="exampleModalLabel">Detalles del pedido</h3>
                                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <form action="/editPedidoPendiente/{{d.codigo_pedido}}" method="post">
              
                                      
                                      <label for="cliente" class="form-label mt-1">Cliente: {{d.nombre_cliente}} {{d.apellido_cliente}}</label>
                                                            
                                       <div> <label>Código de pedido</label></div>
                                        <input type="text" class="codigo_pedido form-control" name="codigo_pedido" value="{{d.codigo_pedido}}" readonly>
                                        <label for="tecnico" class="form-label mt-1">Técnicos asignados</label>
                                          <div name="tecnico" class="form-control" required>
                                            {{d.nombres_tecnicos}}
                                            </div>
                                        <label>Fecha del pedido</label>
                                        <input readonly type="text" class="form-control mb-3 " name="fecha_pedido" value="{{d.fecha_pedido}}">
                                        
                                        <label for="servicio" class="form-label mt-1">Servicios prestados:</label>
                                        <div class="form-control" style="padding-bottom: 15px;">{{d. nombres_servicios_correctivos}}, {{d.nombres_servicios_preventivos}}</div>

                                        <div><label for="fecha_inicio_trabajo" >Fecha de inicio del trabajo</label>
                                        <input class="form-control fecha_inicio_trabajo" value="{{d.fecha_inicio_trabajo}}" required type="text" id="fecha_inicio_trabajo" name="fecha_inicio_trabajo" class="fecha_inicio_trabajo" required></div>
                                        <label for="fecha_fin_trabajo" >Fecha de finalización del trabajo</label>
                                        <input value="{{d.fecha_fin_trabajo}}" class="form-control fecha_fin_trabajo  "required type="text" id="fecha_fin_trabajo" name="fecha_fin_trabajo" class="fecha_fin_trabajo" >
                                        
                                        <label for="total a pagar">Total a pagar (USD)</label>
                                        <input value="{{d.total_a_pagar}}" class="form-control total_a_pagar" type="number" id="total_a_pagar" name="total_a_pagar" class="total_a_pagar" data-valor-inicial="{{d.total_a_pagar}}">
                                        <div class="text-muted">Moneda nacional: <span class="monto_bs">0.00</span> Bs</div>
                                        <div class="text-muted">Tasa del día: {{tasa_bcv}}</div>
                                      <label class="text-muted">Registrado por empleado {{d.cedula_empleado_registra}} {{d.nombre_empleado}} {{d.apellido_empleado}}</label>

                                </div>
                                <div class="modal-footer">
                                </div>
                                    </form>
                                  </div>
                                </div>
                              </div>
              
                            
                                  </div>
                                </div>
                              </div>

           
        

                  <!-- Modal para actualizar estado de proceso POr atender-->
            <div class="modal fade" id="modalDefault{{d.codigo_pedido}}" tabindex="-1" aria-labelledby="modalToggleLabel{{d.codigo_pedido}}" aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <h3 class="modal-title fs-5" id="modalToggleLabel{{d.codigo_pedido}}">Actualizar estado del pedido</h3>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                    <div class="text-muted">
                      <div><strong>Cliente:</strong> {{d.cedula_cliente}} {{d.nombre_cliente}} {{d.nombre_apellido}}</div>
                      <div><strong>Técnico asignado:</strong> {{ d.nombres_tecnicos }}</div>
                      <div><strong>  Fecha del pedido:</strong>  {{ d.fecha_pedido }}     </div>
                      <form action="/actualizarPedido/{{ d.codigo_pedido }}" method="post">

                      <div>Codigo del pedido<INPUT name="codigo_pedido" id="codigo_pedido"  class="form-control" type="TEXT" value=" {{d.codigo_pedido}}" readonly></div>
                    </div>
                    
                      <label for="servicio" class="form-label mt-1">Servicios prestados:</label>
                      <div>
                        <div class="servicios-container">
                          <label for="servicios_correctivo">Correctivos</label>
                          <select class="servicios-select servicios-correctivo form-control" name="serviciosSeleccionados[]" multiple>
                              {% for s in dataServiciosCorrectivos %}
                                  <option value="{{ s.codigo_servicio }}"
                                      {% if d.codigos_servicios and s.codigo_servicio|string in d.codigos_servicios.split(',') %} selected {% endif %}>
                                      {{ s.descripcion }}
                                  </option>
                              {% endfor %}
                          </select>
                      </div>
                      
                      <div class="servicios-container">
                          <label for="servicios_preventivo">Preventivos</label>
                          <select class="servicios-select servicios-preventivo form-control" name="serviciosSeleccionados[]" multiple>
                              {% for s in dataServiciosPreventivos %}
                                  <option value="{{ s.codigo_servicio }}"
                                      {% if d.codigos_servicios and s.codigo_servicio|string in d.codigos_servicios.split(',') %} selected {% endif %}>
                                      {{ s.descripcion }}
                                  </option>
                              {% endfor %}
                          </select>
                      </div>
                      

                      <label >Fecha de inicio del trabajo</label>
                      <input class="form-control fecha_inicio_trabajo"  type="text" id="fecha_inicio_trabajo" name="fecha_inicio_trabajo" class="fecha_inicio_trabajo" required>
                      
                      <label >Fecha de finalización del trabajo</label>
                      <input class="form-control fecha_fin_trabajo " type="text" id="fecha_fin_trabajo" name="fecha_fin_trabajo" class="fecha_fin_trabajo" >
                      
                      <label for="total a pagar">Total a pagar (USD)</label>
                      <input class="form-control total_a_pagar" type="number" id="total_a_pagar" name="total_a_pagar" class="total_a_pagar" >
                      <div class="text">Moneda nacional: <span class="monto_bs">0.00</span> Bs</div>
                                  <div class="text-muted">Tasa del día: {{tasa_bcv}}</div>
                      <!-- Checkbox para marcar cancelado -->
                      <label for="cancelado{{ d.codigo_pedido }}">Pago cancelado</label>
                      <input type="checkbox" id="cancelado{{ d.codigo_pedido }}"  value="1" name="cancelado" class="cancelado-checkbox" 
                            data-codigo_pedido="{{ d.codigo_pedido }}" {% if d.cancelado %} checked {% endif %}>

                      <!-- Campos adicionales ocultos -->
                      <div id="detallesPago{{ d.codigo_pedido }}" class="detalles-pago" style="display: none;">
                          <label>Fecha de pago</label>
                          <input class="form-control fecha_pago"type="text" name="fecha_pago" class="fecha_pago" id="fecha_pago">

                          <label>Tipo de moneda</label>
                          <select class="form-control"id="tipo_moneda{{ d.codigo_pedido }}" class="tipo-moneda" name="tipo_moneda">
                              <option value="bolivares">Bolívares</option>
                              <option value="divisas">Divisas</option>
                          </select>

                          <div id="metodoPagoContainer{{ d.codigo_pedido }}" style="display: none;">
                              <label>Método de pago</label>
                              <select  class="form-control" id="metodo_pago{{ d.codigo_pedido }}" class="metodo-pago" name="metodo_pago">
                                  <!-- Opciones dinámicas en JS -->
                              </select>
                          </div>

                          <div id="referenciaContainer{{ d.codigo_pedido }}" style="display: none;">
                              <label>Referencia</label>
                              <input type="number" class="form-control" id="referencia{{ d.codigo_pedido }}" name="referencia">
                          </div>
                      </div>
                      <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Guardar cambios</button>
                      </div>
                    
                      <!-- Campos del formulario -->
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Modal actualizar pedido estado en proceso-->
          <div class="modal fade" id="modalActualizarEnProceso{{d.codigo_pedido}}" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h3 class="modal-title fs-5">Actualizar Pedido - En Proceso</h3>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <form action="/actualizarPedidoProceso/{{d.codigo_pedido}}" method="post">
                    <label>Codigo de pedido</label>
                    <input readonly type="text" value="{{d.codigo_pedido}}" name="codigo_pedido" class="form-control">
                      <label >Fecha de finalización del trabajo</label>
                      <input required type="text" id="fecha_fin_trabajo" name="fecha_fin_trabajo" class="form-control fecha_fin_trabajo" >
                      <label for="total a pagar">Total a pagar (USD)</label>
                    <input class="form-control total_a_pagar" type="number" id="total_a_pagar" name="total_a_pagar" class="total_a_pagar" >
                    <div class="text">Moneda nacional: <span class="monto_bs">0.00</span> Bs</div>
                    <div class="text-muted">Tasa del día: {{tasa_bcv}}</div>
                        <!-- Checkbox para marcar cancelado -->
                        <label for="cancelado{{ d.codigo_pedido }}">Pago cancelado</label>
                        <input type="checkbox" id="cancelado{{ d.codigo_pedido }}"  value="1" name="cancelado" class="cancelado-checkbox" 
                              data-codigo_pedido="{{ d.codigo_pedido }}" {% if d.cancelado %} checked {% endif %}>

                        <!-- Campos adicionales ocultos -->
                        <div id="detallesPago{{ d.codigo_pedido }}" class="detalles-pago" style="display: none;">
                            <label>Fecha de pago</label>
                      <input type="text" name="fecha_pago" class="form-control fecha_pago" id="fecha_pago">

                            <label>Tipo de moneda</label>
                            <select id="tipo_moneda{{ d.codigo_pedido }}" class="form-control tipo-moneda" name="tipo_moneda">
                                <option value="bolivares">Bolívares</option>
                                <option value="divisas">Divisas</option>
                            </select>

                            <div id="metodoPagoContainer{{ d.codigo_pedido }}" style="display: none;">
                                <label>Método de pago</label>
                                <select id="metodo_pago{{ d.codigo_pedido }}" class="form-control metodo-pago" name="metodo_pago">
                                    <!-- Opciones dinámicas en JS -->
                                </select>
                            </div>

                            <div id="referenciaContainer{{ d.codigo_pedido }}" style="display: none;">
                                <label>Referencia</label>
                                <input type="number" class="form-control" id="referencia{{ d.codigo_pedido }}" name="referencia">
                            </div>
                        </div>
                    <div class="modal-footer">
                      <button type="submit" class="btn btn-primary">Guardar cambios</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
          

          <!--Modal actualizar pdido estado pendiente de pago-->
          <div class="modal fade" id="modalActualizarPendiente{{d.codigo_pedido}}" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h3 class="modal-title fs-5">Actualizar Pedido - Pendiente de Pago</h3>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <form action="/actualizarPedidoPendiente/{{d.codigo_pedido}}" method="post">
                    <label>Codido de pedido</label>
                    <input type="text" class="form-control" readonly value="{{d.codigo_pedido}}" name="codigo_pedido">
                    
                        <!-- Checkbox para marcar cancelado -->
                        <label for="cancelado{{ d.codigo_pedido }}">Pago cancelado</label>
                        <input type="checkbox" id="cancelado{{ d.codigo_pedido }}"  value="1" name="cancelado" class="cancelado-checkbox" 
                              data-codigo_pedido="{{ d.codigo_pedido }}" {% if d.cancelado %} checked {% endif %}>

                        <!-- Campos adicionales ocultos -->
                        <div id="detallesPago{{ d.codigo_pedido }}" class="detalles-pago" style="display: none;">
                            <label>Fecha de pago</label>
                      <input type="text" name="fecha_pago" class="form-control fecha_pago" id="fecha_pago">

                            <label>Tipo de moneda</label>
                            <select id="tipo_moneda{{ d.codigo_pedido }}" class="form-control tipo-moneda" name="tipo_moneda">
                                <option value="bolivares">Bolívares</option>
                                <option value="divisas">Divisas</option>
                            </select>

                            <div id="metodoPagoContainer{{ d.codigo_pedido }}" style="display: none;">
                                <label>Método de pago</label>
                                <select id="metodo_pago{{ d.codigo_pedido }}" class="form-control metodo-pago" name="metodo_pago">
                                    <!-- Opciones dinámicas en JS -->
                                </select>
                            </div>

                            <div id="referenciaContainer{{ d.codigo_pedido }}" style="display: none;">
                                <label>Referencia</label>
                                <input type="number" class="form-control" id="referencia{{ d.codigo_pedido }}" name="referencia">
                            </div>
                        </div>
                    <div class="modal-footer">
                      <button type="submit" class="btn btn-primary">Guardar cambios</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
              

     
                  
  
  
  
  
                </div>
                <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
                <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
                <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"> </script>
                <!-- Flatpickr JS -->
                <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
                <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>
                <script>
                  document.addEventListener('DOMContentLoaded', () => {
    // Inicialización de flatpickr para todos los elementos con las clases correspondientes
    flatpickr(".fecha_pedido", {
        dateFormat: "Y-m-d",
        enableTime: false,
        locale: "es"
    });

    flatpickr(".fecha_inicio_trabajo", {
        dateFormat: "Y-m-d",
        enableTime: false,
        locale: "es"
    });

    flatpickr(".fecha_fin_trabajo", {
        dateFormat: "Y-m-d",
        enableTime: false,
        locale: "es"
    });

    flatpickr(".fecha_pago", {
        dateFormat: "Y-m-d",
        enableTime: false,
        locale: "es"
    });
});

                
                  // Inicialización de select2
                  $(document).ready(function() {
                    $('.tecnicos-select').select2({ width: '100%', allowClear: true, placeholder: "--- Seleccione Técnicos ---" });
                    $('.servicios-select').select2({ width: '100%', allowClear: true, placeholder: "--- Seleccione Servicios ---" });
                  });
                
                  function filtrarPedidos(filtro) {
  let pedidos = document.querySelectorAll('.pedido-item');

  pedidos.forEach(pedido => {
      if (filtro === 'todos') {
          pedido.style.display = 'flex';
      } else if (pedido.classList.contains(filtro)) {
          pedido.style.display = 'flex';
      } else {
          pedido.style.display = 'none';
      }
  });
      };

      let filtroEstadoActual = "todos";
  let filtroFechaActual = "";
  let filtroOrdenActual = ""; // nuevo

  document.getElementById("btn-exportar-pdf").addEventListener("click", function (e) {
      e.preventDefault();

      let url = "/generar-reporte-completo-pedidos";
      const params = [];

      if (filtroEstadoActual !== "todos") {
          params.push("estado=" + encodeURIComponent(filtroEstadoActual));
      }

      if (["hoy", "semana", "mes"].includes(filtroFechaActual)) {
          params.push("fecha=" + encodeURIComponent(filtroFechaActual));
      }

      if (["reciente", "antiguo"].includes(filtroOrdenActual)) {
          params.push("orden=" + encodeURIComponent(filtroOrdenActual));
      }

      if (params.length > 0) {
          url += "?" + params.join("&");
      }

      window.location.href = url;
  });

  // Cuando cambia el select de fecha/orden
  document.getElementById("orden-fecha").addEventListener("change", function () {
      const valor = this.value;

      if (["hoy", "semana", "mes", ""].includes(valor)) {
          filtroFechaActual = valor;
          filtroOrdenActual = "";
      } else if (["reciente", "antiguo"].includes(valor)) {
          filtroOrdenActual = valor;
          filtroFechaActual = "";
      }

      aplicarFiltrosCombinados();
  });

  function actualizarFiltroEstado(filtro) {
      filtroEstadoActual = filtro;
      aplicarFiltrosCombinados();
  }

  function aplicarFiltrosCombinados() {
      const hoy = new Date();
      const pedidos = document.querySelectorAll('.pedido-item');

      pedidos.forEach(pedido => {
          const estadoOk = filtroEstadoActual === 'todos' || pedido.classList.contains(filtroEstadoActual);

          const dataFecha = pedido.getAttribute("data-fecha");
          const [anio, mes, dia] = dataFecha.split("-").map(Number);
          const fechaPedido = new Date(anio, mes - 1, dia);

          let fechaOk = true;

          if (filtroFechaActual === "hoy") {
              fechaOk = hoy.getFullYear() === anio &&
                        (hoy.getMonth() + 1) === mes &&
                        hoy.getDate() === dia;
          } else if (filtroFechaActual === "semana") {
              const haceUnaSemana = new Date();
              haceUnaSemana.setDate(hoy.getDate() - 7);
              fechaOk = fechaPedido >= haceUnaSemana;
          } else if (filtroFechaActual === "mes") {
              const haceUnMes = new Date();
              haceUnMes.setMonth(hoy.getMonth() - 1);
              fechaOk = fechaPedido >= haceUnMes;
          }

          if (estadoOk && fechaOk) {
              pedido.style.display = "flex";
          } else {
              pedido.style.display = "none";
          }
      });

      // Ordenar por fecha si es necesario
      if (filtroOrdenActual === "reciente" || filtroOrdenActual === "antiguo") {
          const contenedor = document.getElementById("pedidos-container");
          const pedidosArray = Array.from(pedidos).filter(p => p.style.display === "flex");

          pedidosArray.sort((a, b) => {
              const fechaA = new Date(a.getAttribute("data-fecha"));
              const fechaB = new Date(b.getAttribute("data-fecha"));
              return filtroOrdenActual === "reciente" ? fechaB - fechaA : fechaA - fechaB;
          });

          pedidosArray.forEach(pedido => contenedor.appendChild(pedido));
      }
  }
                </script>
<script>
  // Manejo de modales y campos dependientes
  document.querySelectorAll(".modal").forEach(modal => {
      modal.addEventListener('shown.bs.modal', () => {
          const codigo_pedido = modal.id.replace(/[^0-9]/g, '');
          const checkbox = modal.querySelector(`#cancelado${codigo_pedido}`);
          const detallesPago = modal.querySelector(`#detallesPago${codigo_pedido}`);
          const tipoMoneda = modal.querySelector(`#tipo_moneda${codigo_pedido}`);
          const metodoPago = modal.querySelector(`#metodo_pago${codigo_pedido}`);
          const metodoPagoContainer = modal.querySelector(`#metodoPagoContainer${codigo_pedido}`);
          const referenciaContainer = modal.querySelector(`#referenciaContainer${codigo_pedido}`);
          
          if (!checkbox || !detallesPago || !tipoMoneda || !metodoPago || !metodoPagoContainer || !referenciaContainer) {
              console.warn(`Algunos elementos del modal ${codigo_pedido} no se encontraron.`);
              return;
          }

          function actualizarCampos() {
              detallesPago.style.display = checkbox.checked ? "block" : "none";
              if (!checkbox.checked) {
                  metodoPagoContainer.style.display = "none";
                  referenciaContainer.style.display = "none";
              }
          }

          function actualizarMetodosPago() {
              metodoPago.innerHTML = "";
              metodoPagoContainer.style.display = "block";
              if (tipoMoneda.value === "bolivares") {
                  metodoPago.innerHTML = `<option value="efectivo">Efectivo</option><option value="pago_movil">Pago Móvil</option>`;
              } else {
                  metodoPago.innerHTML = `<option value="efectivo">Efectivo</option><option value="transferencia">Transferencia</option>`;
              }
          }

          function actualizarReferencia() {
            if (metodoPago && referenciaContainer && tipoMoneda) {
        if (
            metodoPago.value === "pago_movil" ||
            metodoPago.value === "transferencia" ||
            (tipoMoneda.value === "divisas" && metodoPago.value === "efectivo")
        ) {
            referenciaContainer.style.display = "block";
        } else {
            referenciaContainer.style.display = "none";
        }
    }
}

checkbox.addEventListener("change", actualizarCampos);
          tipoMoneda.addEventListener("change", () => {
              actualizarMetodosPago();
              actualizarReferencia();
          });
          metodoPago.addEventListener("change", actualizarReferencia);

          actualizarCampos();
          actualizarMetodosPago();
          actualizarReferencia();
      });
  });
</script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const tasaBCV = parseFloat("{{ tasa_bcv }}");
    console.log("Tasa BCV:", tasaBCV);
    document.querySelectorAll('.total_a_pagar').forEach(function(input) {
        input.addEventListener('input', function() {
            const valorFormateado = this.value;
            const montoUSD = parseFloat(valorFormateado) || 0;
            console.log("Monto USD:", montoUSD);
            const montoBsElement = this.closest('.modal').querySelector('.monto_bs');
            if (montoBsElement) {
                if (!isNaN(montoUSD)) {
                    const montoBS = montoUSD * tasaBCV;
                    montoBsElement.textContent = montoBS.toFixed(2);
                } else {
                    montoBsElement.textContent = "0.00";
                }
            } else {
                console.log("No se encontro el elemento monto_bs")
            }
        });
    });
  });
</script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
      const inputBusqueda = document.getElementById("buscarPedido");
      const pedidos = document.querySelectorAll("#pedidos-container .pedido-item");
  
      inputBusqueda.addEventListener("keyup", function() {
          const filtro = this.value.toLowerCase();
  
          pedidos.forEach(pedido => {
              const textoPedido = pedido.textContent.toLowerCase();
              pedido.style.display = textoPedido.includes(filtro) ? "block" : "none";
          });
      });
  });
  </script>                              


{% endfor %}

  
{% endblock %}
